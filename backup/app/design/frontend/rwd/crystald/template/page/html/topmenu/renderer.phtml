<?php
/**
 * Magento
 *
 * NOTICE OF LICENSE
 *
 * This source file is subject to the Academic Free License (AFL 3.0)
 * that is bundled with this package in the file LICENSE_AFL.txt.
 * It is also available through the world-wide-web at this URL:
 * http://opensource.org/licenses/afl-3.0.php
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@magento.com so we can send you a copy immediately.
 *
 * DISCLAIMER
 *
 * Do not edit or add to this file if you wish to upgrade Magento to newer
 * versions in the future. If you wish to customize Magento for your
 * needs please refer to http://www.magento.com for more information.
 *
 * @category    design
 * @package     rwd_default
 * @copyright   Copyright (c) 2006-2015 X.commerce, Inc. (http://www.magento.com)
 * @license     http://opensource.org/licenses/afl-3.0.php  Academic Free License (AFL 3.0)
 */
/** @var Mage_Page_Block_Html_Topmenu_Renderer $this */
/** @var Varien_Data_Tree_Node $menuTree */
/** @var string $childrenWrapClass */

$html = '';
$_resource = Mage::getResourceModel('catalog/category');
$target = '';
$baseUrl = Mage::getBaseUrl();

$children = $menuTree->getChildren();
$parentLevel = $menuTree->getLevel();
$childLevel = is_null($parentLevel) ? 0 : $parentLevel + 1;

$counter = 1;
$childrenCount = $children->count();

$parentPositionClass = $menuTree->getPositionClass();
$itemPositionClassPrefix = $parentPositionClass ? $parentPositionClass . '-' : 'nav-';

//Used to hide certain links for general and guest users
$customerGroupId = Mage::getSingleton('customer/session')->getCustomerGroupId();
$employeeGroups = array(4 , 6);

foreach ($children as $child) {
    $child->setLevel($childLevel);
    $child->setIsFirst($counter == 1);
    $child->setIsLast($counter == $childrenCount);
    $child->setPositionClass($itemPositionClassPrefix . $counter);
	$target = '';

	//The client needs the ability to setup links to go to any outside source.  This checks to see if there is an override url
	$categoryId = str_replace('category-node-', '', $child->getId());
	$urlOverride = $_resource->getAttributeRawValue($categoryId,  'url_override', Mage::app()->getStore()->getId());
	$openNewTab = $_resource->getAttributeRawValue($categoryId,  'open_new_tab', Mage::app()->getStore()->getId());

	if($urlOverride) {
		$url = $urlOverride;
	} else {
		$url = $child->getUrl();
	}

	if($openNewTab) {
		$target = ' target="_blank" ';
	}

    $outermostClassCode = 'level'. $childLevel;
    $_hasChildren = ($child->hasChildren()) ? 'has-children' : '';

	//Add a class to hide the current link if the user does not belong to the employee group
	$hideClass = '';
	if(!in_array($customerGroupId, $employeeGroups) && $categoryId == 247) {
		$hideClass = 'hide ';
	}

	if($child->getName() == 'Awards & Gifts') {
		$html .= '<li class="level0 nav-2 parent open">';
	}else {
		$html .= '<li '. $this->_getRenderedMenuItemAttributes($child) .'>';
	}



	$html .= '<a '.$target.' href="'. $url .'" class="'.$hideClass . $outermostClassCode .' '. $_hasChildren .'">'. $this->escapeHtml($this->__($child->getName())) .'</a>';

    if (!empty($childrenWrapClass)) {
        $html .= '<div class="'. $childrenWrapClass .'">';
    }

    $nextChildLevel = $childLevel + 1;

	if($child->getName() == 'Awards & Gifts') {
		$html .= '<ul class="dropdown-menu dropdown-menu-large row horizontal-menu">';

		//Next need to get all of the children for awards and gifts
		$topLevelChildren = $child->getChildren();
		foreach ($topLevelChildren as $topLevelChild) {
			$html .= '<div class="horizontal-menu-row col-md-2">';
			$html .= '<a class="title-link" href="'.$topLevelChild->getUrl().'"><span class="title">'. $topLevelChild->getName() .'</span></a>';

			//Then need to find the grandChildren of the current level
			$grandChildren = $topLevelChild->getChildren();

			$html .= '<ul class="horizontal-menu-children">';

			//Need to count to only show 7 max
			$i = 1;
			foreach ($grandChildren as $grandChild) {
				$grandChildCategoryId = $categoryId = str_replace('category-node-', '', $grandChild->getId());
				$html .= '<li><a class="children-links" href="/products?cat=' . $grandChildCategoryId.'">'. $grandChild->getName() .'</a></li>';

				if($i == 7) {
					$html .= '<li><a class="view-all children-links" href="'.$topLevelChild->getUrl().'">View All</a></li>';
					break;
				}
				$i++;
			}
			$html .= '</ul>';
			$html .= '</div>';
		}

		//Add in a few more links to the bottom
		$html .= '<div class="horizontal-menu-row bottom-links col-md-12">';
		$html .= '<ul class="logged-in-links">';
		$html .= '<li class="col-md-4"><a href="'.$baseUrl.'digital-catalog/Full-Line-Catalog/mobile/index.html">Full-Line Catalog</a></li>';
		$html .= '<li class="col-md-4"><a href="'.$baseUrl.'digital-catalog/3D-Subsurface-Catalog/mobile/index.html">3D Subsurface Catalog</a></li>';

		//Used so when the links wrap they stay center with everything else
		$specialClass = 'col-md-4';
		if($customerGroupId == 4) {
			$html .= '<li class="col-md-4"><a href="'.$baseUrl.'price_guide/mobile/index.html">Trophy Price Guide</a></li>';
			$specialClass = 'col-md-12';
		}
		$html .= '<li class="'.$specialClass.'"><a href="'.$baseUrl.'products/custom-awards">Custom Awards</a></li>';
		$html .= '</ul>';
		$html .= '</div>';


        $html .= '</ul>';
	}
    elseif (!empty($_hasChildren)) {
        $html .= '<ul class="level'. $childLevel .' first-list">';
		$html .=     '<li class="level'. $nextChildLevel .' view-all">';
        $html .=         '<a '.$target.' class="level'. $nextChildLevel .'" href="'. $url .'">';
        $html .=             $this->__('') . ' ' . $this->escapeHtml($this->__($child->getName()));
        $html .=         '</a>';
        $html .=     '</li>';
        $html .=     $this->render($child, $childrenWrapClass);
        $html .= '</ul>';
    }

    if (!empty($childrenWrapClass)) {
        $html .= '</div>';
    }

    $html .= '</li>';

    $counter++;
}

return $html;